# 存储相关知识

## 存储信息调试查看

### 查看当前磁盘的写入有多大

```shell
iostat -k 30
```

iostat命令可以查看磁盘的分区的平均写入速度，和每个分区总共写入了多少数据。

`-k` 表示以KB为单位查看。

`30` 表示每30秒统计一次平均值。

### 查看某个进程打开了哪些文件

`lsof`命令可以看到哪些文件被哪些进程打开了。之后再使用grep过滤关注的文件或进程。

### 查看所有进程对磁盘的实时写入速度

```bash
pidstat -d 10
```

pidstat可以查看各个进程的信息

`-d` 表示查看磁盘读写信息。

`10` 表示每10秒统计一次平均值。

### 查看文件系统的文件块大小

```shell
stat -f dir
```

## 文件系统写入特性

每次写入都是按块写入，一般一个块是4096 Byte大小，且写入的同时会修改文件的修改时间。所以如果写入一个文件一个字节，其实相当于写入了两个块（8KB）。

为了降低emmc的写入量，降低写入放大，应该每次写入尽量大的值，使文件的修改时间这部分的消耗尽量低，比如每次写入8个块大小。实际写入了8个数据块+1个文件信息块。写入放大为9/8 = 1.125倍。当然文件系统本身的日志记录也有一部分，这里不受我们控制，先不做讨论。
